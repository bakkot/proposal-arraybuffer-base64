<!doctype html>
<head>
<meta charset="utf-8">
<title>Base64 in JavaScript proposal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="./water-light.css">
<link rel="stylesheet" type="text/css" href="./style.css">
<link rel="stylesheet" type="text/css" href="./prism.css">
<script type="module" src="./polyfill-install.mjs"></script>
<script>
// logic for making codeblocks copyable
// svg from https://feathericons.com/
let copySVG = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';

if (navigator.clipboard) {
  addEventListener('DOMContentLoaded', () => {
    for (let pre of document.querySelectorAll('pre[class*="language-"]')) {
      let button = document.createElement('button');

      button.innerHTML = copySVG;
      button.title = 'Copy'
      pre.appendChild(button);

      button.addEventListener('click', async () => {
        let code = pre.querySelector('code');
        try {
          await navigator.clipboard.writeText(code.innerText);
          button.innerText = 'âœ“';
          button.style.color = 'green';
        } catch (e) {
          console.error(e);
          button.innerText = 'Failed to copy';
          button.style.color = 'red';
        }

        setTimeout(() => {
          button.innerHTML = copySVG;
          button.style.color = '';
          button.blur();
        }, 1000);
      });
    }
  });
}
</script>
<body>

<h1>Proposed Support for Base64 in JavaScript</h1>

<h2 id="introduction">Introduction</h2>
<p>This page documents an early-stage proposal for native base64 and hex encoding and decoding for binary data in JavaScript, and includes a <strong>non-production, slightly inaccurate</strong> polyfill you can experiment with in the browser's console. Some details of the polyfill, particularly around coercion and order of observable effects, are not identical to the proposed spec text.</p>
<p>The proposal would provide methods for encoding and decoding Uint8Arrays as base64 and hex strings.</p>
<p>Feedback on <a href="https://github.com/tc39/proposal-arraybuffer-base64">the proposal's repository</a> is appreciated.</p>

<h2 id="API">API</h2>
<h3>Basic usage</h3>
<p>Encoding a Uint8Array to a base64 string:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">toBase64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 'SGVsbG8gV29ybGQ='</span>
</code></pre>

<p>Decoding a base64 string to a Uint8Array:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> string <span class="token operator">=</span> <span class="token string">'SGVsbG8gV29ybGQ='</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Uint8Array<span class="token punctuation">.</span><span class="token function">fromBase64</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Uint8Array([72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100])</span>
</code></pre>

<p>Encoding a Uint8Array to a hex string:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">toHex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// '48656c6c6f20576f726c64='</span>
</code></pre>

<p>Decoding a hex string to a Uint8Array:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> string <span class="token operator">=</span> <span class="token string">'48656c6c6f20576f726c64'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Uint8Array<span class="token punctuation">.</span><span class="token function">fromHex</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Uint8Array([72, 101, 108, 108, 111, 32, 87, 111, 114, 108, 100])</span>
</code></pre>

<h3>Options</h3>
<p>The base64 methods take an optional options bag which allows specifying the alphabet as either "base64" (the default) or "base64url" (<a href="https://datatracker.ietf.org/doc/html/rfc4648#section-5">the URL-safe variant</a>).</p>
<p>In the future this may allow specifying arbitrary alphabets.</p>
<p>In later versions of this proposal the options bag may also allow additional options, such as specifying whether to generate / enforce padding characters and how to handle whitespace.</p>
<p>The hex methods do not have any options.</p>

<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">251</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">191</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">toBase64</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">alphabet</span><span class="token operator">:</span> <span class="token string">'base64'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// '+/+/'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">toBase64</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">alphabet</span><span class="token operator">:</span> <span class="token string">'base64url'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// '-_-_'</span>
</code></pre>

<h3>Streaming</h3>
<p>Two additional methods, <code>toPartialBase64</code> and <code>fromPartialBase64</code>, allow encoding and decoding chunks of base64. This requires managing state, which is handled by returning a <code>{ result, extra }</code> pair. The options bag for these methods takes two additional arguments, one which specifies whether more data is expected and one which specifies any extra values returned by a previous call.</p>
<p>These methods are intended for lower-level use and are less convenient to use.</p>
<p>Streaming versions of the hex APIs are not included since they are straightforward to do manually.</p>

<p>Streaming an ArrayBuffer into chunks of base64 strings:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>
<span class="token keyword">let</span> chunkSize <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> resultChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> result<span class="token punctuation">,</span> extra<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>byteLength<span class="token punctuation">;</span> offset <span class="token operator">+=</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>chunkSize<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>byteLength <span class="token operator">-</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token punctuation">{</span> result<span class="token punctuation">,</span> extra <span class="token punctuation">}</span> <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">toPartialBase64</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">more</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> extra <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  resultChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span> result <span class="token punctuation">}</span> <span class="token operator">=</span> extra<span class="token punctuation">.</span><span class="token function">toPartialBase64</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">more</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
resultChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>resultChunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ['mpmZmZmZ', 'uT+amZmZ', 'mZnJPzMz', 'MzMzM9M/', 'mpmZmZmZ', '', '2T8=']</span>
</code></pre>

<p>Streaming base64 strings into Uint8Arrays:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'mpmZmZmZuT+am'</span><span class="token punctuation">,</span> <span class="token string">'ZmZmZnJPzMz'</span><span class="token punctuation">,</span> <span class="token string">'MzMz'</span><span class="token punctuation">,</span> <span class="token string">'M9M/mpmZmZmZ'</span><span class="token punctuation">,</span> <span class="token string">'2T8='</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// individual chunks are not necessarily correctly-padded base64 strings</span>

<span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">maxByteLength</span><span class="token operator">:</span> <span class="token number">1024</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> result<span class="token punctuation">,</span> extra<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> c <span class="token keyword">of</span> chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span><span class="token punctuation">{</span> result<span class="token punctuation">,</span> extra <span class="token punctuation">}</span> <span class="token operator">=</span> Uint8Array<span class="token punctuation">.</span><span class="token function">fromPartialBase64</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">more</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> extra <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> offset <span class="token operator">=</span> output<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newLength <span class="token operator">=</span> offset <span class="token operator">+</span> result<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  output<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>newLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  output<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// if padding was optional,</span>
<span class="token comment">// you'd need to do a final `fromPartialBase64` call here with `more: false`</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Float64Array([0.1, 0.2, 0.3, 0.4])</span>
</code></pre>

<p>Note that the above snippet makes use of the <a href="https://github.com/tc39/proposal-resizablearraybuffer">Growable ArrayBuffers</a> proposal for illustration, which not all browsers support as of this writing.</p>

<p>A more involved example, creating a TransformStream which encodes contiguous Uint8Arrays:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BufferToStringTransformStream</span> <span class="token keyword">extends</span> <span class="token class-name">TransformStream</span> <span class="token punctuation">{</span>
  #extra <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">alphabet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">transform</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span> result<span class="token punctuation">,</span> extra <span class="token punctuation">}</span> <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toPartialBase64</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          alphabet<span class="token punctuation">,</span>
          <span class="token literal-property property">extra</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#extra<span class="token punctuation">,</span>
          <span class="token literal-property property">more</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>#extra <span class="token operator">=</span> extra<span class="token punctuation">;</span>
        controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">flush</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#extra <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// stream was empty</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span> result <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#extra<span class="token punctuation">.</span><span class="token function">toPartialBase64</span><span class="token punctuation">(</span><span class="token punctuation">{</span> alphabet <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// use:</span>
<span class="token keyword">let</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sink <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WritableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunks<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'AQIDBA=='</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

source
  <span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferToStringTransformStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipeTo</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>

<footer>
  <p>Thanks for reading! If you got this far, you should try out the proposal in your browser's developer tools on this page, and submit feedback on <a href="https://github.com/tc39/proposal-arraybuffer-base64">GitHub</a>.</p>
</footer>

